-- Coffee Shop Database Initialization Script

-- Drop existing types and tables if they exist to ensure clean setup
DROP TYPE IF EXISTS order_status CASCADE;
DROP TYPE IF EXISTS temperature_type CASCADE;
DROP TYPE IF EXISTS transaction_type CASCADE;
DROP TYPE IF EXISTS measurement_unit CASCADE;
DROP TYPE IF EXISTS menu_category CASCADE;

-- Create Custom Types
CREATE TYPE order_status AS ENUM ('pending', 'in_progress', 'completed', 'cancelled');
CREATE TYPE temperature_type AS ENUM ('hot', 'warm', 'cold', 'iced');
CREATE TYPE transaction_type AS ENUM ('restock', 'use', 'adjustment', 'write_off');
CREATE TYPE measurement_unit AS ENUM ('kg', 'g', 'ml', 'l', 'piece');
CREATE TYPE menu_category AS ENUM ('coffee', 'tea', 'pastry', 'sandwich', 'cold_drink', 'breakfast');

-- Create Inventory Table
CREATE TABLE inventory (
    id SERIAL PRIMARY KEY,
    ingredient_name VARCHAR(100) NOT NULL UNIQUE,
    quantity DECIMAL(10, 2) NOT NULL CHECK (quantity >= 0),
    unit measurement_unit NOT NULL,
    reorder_threshold DECIMAL(10, 2) CHECK (reorder_threshold >= 0),
    is_perishable BOOLEAN DEFAULT FALSE,
    shelf_life INTERVAL,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create Menu Items Table
CREATE TABLE menu_items (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    description TEXT,
    base_price DECIMAL(10, 2) NOT NULL CHECK (base_price > 0),
    category menu_category NOT NULL,
    is_available BOOLEAN DEFAULT TRUE,
    preparation_time INTERVAL,
    temperature temperature_type,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create Menu Item Ingredients Junction Table
CREATE TABLE menu_item_ingredients (
    menu_item_id INT REFERENCES menu_items(id) ON DELETE CASCADE,
    ingredient_id INT REFERENCES inventory(id) ON DELETE CASCADE,
    required_quantity DECIMAL(10, 2) NOT NULL CHECK (required_quantity > 0),
    PRIMARY KEY (menu_item_id, ingredient_id)
);

-- Create Orders Table
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    customer_name VARCHAR(100) NOT NULL,
    total_amount DECIMAL(10, 2) NOT NULL CHECK (total_amount >= 0),
    status order_status NOT NULL DEFAULT 'pending',
    special_instructions JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create Order Items Table
CREATE TABLE order_items (
    order_id INT REFERENCES orders(id) ON DELETE CASCADE,
    menu_item_id INT REFERENCES menu_items(id) ON DELETE CASCADE,
    quantity INT CHECK(quantity > 0),
    item_price DECIMAL(10, 2) NOT NULL CHECK (item_price > 0),
    PRIMARY KEY (order_id, menu_item_id)
);

-- Create Order Status History Table
CREATE TABLE order_status_history (
    id SERIAL PRIMARY KEY,
    order_id INT REFERENCES orders(id) ON DELETE CASCADE,
    previous_status order_status,
    new_status order_status NOT NULL,
    changed_by VARCHAR(50),
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create Inventory Transaction Table
CREATE TABLE inventory_transaction (
    id SERIAL PRIMARY KEY,
    inventory_id INT REFERENCES inventory(id) ON DELETE CASCADE,
    transaction_type transaction_type NOT NULL DEFAULT 'use',
    quantity DECIMAL(10, 2) NOT NULL,
    current_stock DECIMAL(10, 2),
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create Price History Table
CREATE TABLE price_history (
    id SERIAL PRIMARY KEY,
    menu_item_id INT REFERENCES menu_items(id) ON DELETE CASCADE,
    old_price DECIMAL(10, 2),
    new_price DECIMAL(10, 2) NOT NULL,
    change_reason TEXT,
    effective_from TIMESTAMPTZ DEFAULT NOW(),
    effective_to TIMESTAMPTZ
);

-- Create Indexes
CREATE INDEX idx_menu_items_category ON menu_items(category);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_created_at ON orders(created_at);
CREATE INDEX idx_inventory_ingredient_name ON inventory(ingredient_name);
CREATE INDEX idx_order_status_history_order_id ON order_status_history(order_id);
CREATE INDEX idx_inventory_transaction_inventory_id ON inventory_transaction(inventory_id);

-- Full Text Search Index
CREATE INDEX idx_menu_items_search ON menu_items USING GIN (to_tsvector('english', name || ' ' || COALESCE(description, '')));

-- Mock Data Inserts

-- Inventory Inserts
INSERT INTO inventory (ingredient_name, quantity, unit, reorder_threshold, is_perishable, shelf_life) VALUES
('Arabica Coffee Beans', 50.5, 'kg', 10.0, TRUE, INTERVAL '3 months'),
('Robusta Coffee Beans', 30.0, 'kg', 5.0, TRUE, INTERVAL '3 months'),
('Milk', 200.0, 'l', 50.0, TRUE, INTERVAL '1 week'),
('Soy Milk', 50.0, 'l', 10.0, TRUE, INTERVAL '1 week'),
('Sugar', 25.0, 'kg', 5.0, FALSE, NULL),
('Chocolate Syrup', 15.0, 'l', 3.0, FALSE, INTERVAL '6 months'),
('Espresso Shots', 500, 'piece', 100, FALSE, NULL),
('Croissant Dough', 30.0, 'kg', 5.0, TRUE, INTERVAL '2 days'),
('Flour', 100.0, 'kg', 20.0, FALSE, NULL),
('Eggs', 200, 'piece', 50, TRUE, INTERVAL '2 weeks');

-- Menu Items Inserts
INSERT INTO menu_items (name, description, base_price, category, temperature, preparation_time) VALUES
('Espresso', 'Short, strong coffee', 2.50, 'coffee', 'hot', INTERVAL '2 minutes'),
('Cappuccino', 'Espresso with steamed milk foam', 3.75, 'coffee', 'hot', INTERVAL '3 minutes'),
('Latte', 'Espresso with steamed milk', 4.00, 'coffee', 'hot', INTERVAL '3 minutes'),
('Americano', 'Espresso with hot water', 3.00, 'coffee', 'hot', INTERVAL '2 minutes'),
('Iced Coffee', 'Chilled coffee with ice', 4.50, 'cold_drink', 'cold', INTERVAL '5 minutes'),
('Croissant', 'Butter croissant', 2.75, 'pastry', NULL, INTERVAL '10 minutes'),
('Chocolate Croissant', 'Chocolate-filled croissant', 3.25, 'pastry', NULL, INTERVAL '10 minutes'),
('Green Tea', 'Fresh green tea', 2.50, 'tea', 'hot', INTERVAL '3 minutes'),
('Chai Latte', 'Spiced tea with milk', 4.25, 'tea', 'hot', INTERVAL '4 minutes'),
('Ham & Cheese Sandwich', 'Classic sandwich', 5.50, 'sandwich', NULL, INTERVAL '5 minutes');

-- Menu Item Ingredients
INSERT INTO menu_item_ingredients (menu_item_id, ingredient_id, required_quantity) VALUES
(1, 1, 0.02),  -- Espresso needs Arabica Beans
(1, 7, 1),     -- Espresso Shot
(2, 1, 0.02),  -- Cappuccino needs Arabica Beans
(2, 3, 0.1),   -- Milk
(2, 7, 1),     -- Espresso Shot
(3, 1, 0.02),  -- Latte needs Arabica Beans
(3, 3, 0.2),   -- More milk for Latte
(3, 7, 1),     -- Espresso Shot
(4, 1, 0.02),  -- Americano needs Arabica Beans
(4, 7, 1);     -- Espresso Shot

-- Orders
INSERT INTO orders (customer_name, total_amount, status) VALUES
('John Doe', 8.25, 'completed'),
('Jane Smith', 12.50, 'in_progress'),
('Mike Johnson', 6.75, 'pending');

-- Order Items
INSERT INTO order_items (order_id, menu_item_id, quantity, item_price) VALUES
(1, 1, 1, 2.50),
(1, 6, 2, 2.75),
(2, 2, 1, 3.75),
(2, 8, 1, 2.50),
(3, 4, 1, 3.00),
(3, 7, 1, 3.25);

-- Order Status History
INSERT INTO order_status_history (order_id, previous_status, new_status, changed_by, notes) VALUES
(1, NULL, 'pending', 'system', 'Order created'),
(1, 'pending', 'completed', 'staff', 'Order fulfilled'),
(2, NULL, 'pending', 'system', 'Order created'),
(2, 'pending', 'in_progress', 'staff', 'Order started'),
(3, NULL, 'pending', 'system', 'Order created');

-- Price History
INSERT INTO price_history (menu_item_id, old_price, new_price, change_reason) VALUES
(1, NULL, 2.50, 'Initial pricing'),
(2, NULL, 3.75, 'Initial pricing'),
(3, NULL, 4.00, 'Initial pricing');